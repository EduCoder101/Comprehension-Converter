<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Results Analyser Dashboard</title>
<style>
  :root {
    --primary: #1a5276;
    --primary-light: #2980b9;
    --accent: #e67e22;
    --correct: #27ae60;
    --incorrect: #e74c3c;
    --bg: #f4f6f8;
    --card: #ffffff;
    --text: #2c3e50;
    --border: #dce1e6;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }

  /* ========== TOP BAR ========== */
  .top-bar {
    background: var(--primary);
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .top-bar h1 { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .top-bar h1 .icon { font-size: 1.5rem; }
  .top-bar-right { display: flex; align-items: center; gap: 16px; }
  .top-bar .last-loaded { font-size: 0.8rem; opacity: 0.7; }
  .top-bar .tagline { font-size: 0.85rem; opacity: 0.8; margin-left: 10px; }

  /* ========== SETTINGS BAR ========== */
  .settings-bar {
    background: #1b3a4b;
    overflow: hidden;
    transition: max-height 0.35s ease, padding 0.35s ease;
    max-height: 0;
    padding: 0 24px;
  }
  .settings-bar.open {
    max-height: 120px;
    padding: 16px 24px;
  }
  .settings-inner {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .settings-bar label {
    color: rgba(255,255,255,0.8);
    font-size: 0.85rem;
    white-space: nowrap;
  }
  .settings-bar input[type="text"] {
    flex: 1;
    min-width: 280px;
    padding: 8px 14px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .settings-bar input[type="text"]::placeholder { color: rgba(255,255,255,0.4); }
  .settings-bar input[type="text"]:focus { border-color: var(--accent); }

  .btn {
    padding: 8px 20px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .btn-accent {
    background: var(--accent);
    color: white;
  }
  .btn-accent:hover { background: #d35400; }
  .btn-accent:disabled { background: #bdc3c7; cursor: not-allowed; }
  .btn-outline {
    background: transparent;
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
  }
  .btn-outline:hover { background: rgba(255,255,255,0.1); }
  .btn-primary {
    background: var(--primary-light);
    color: white;
  }
  .btn-primary:hover { background: var(--primary); }
  .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
  .btn-settings {
    background: none;
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn-settings:hover { background: rgba(255,255,255,0.1); }

  /* ========== TAB NAVIGATION ========== */
  .tab-nav {
    display: flex;
    background: var(--card);
    border-bottom: 2px solid var(--border);
    padding: 0 24px;
    gap: 0;
  }
  .tab-btn {
    padding: 14px 24px;
    border: none;
    background: none;
    font-size: 0.95rem;
    font-weight: 500;
    color: #7f8c8d;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tab-btn:hover { color: var(--primary); background: rgba(26,82,118,0.04); }
  .tab-btn.active {
    color: var(--primary);
    font-weight: 700;
    border-bottom-color: var(--accent);
  }
  .tab-btn .tab-icon { font-size: 1.1rem; }

  /* ========== MAIN CONTENT ========== */
  .main-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ========== CARDS ========== */
  .card {
    background: var(--card);
    border-radius: 10px;
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
  }
  .card-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ========== TEST OVERVIEW GRID ========== */
  .test-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
  }
  .test-card {
    background: var(--card);
    border-radius: 10px;
    box-shadow: var(--shadow);
    padding: 24px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }
  .test-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
    border-color: var(--primary-light);
  }
  .test-card-name {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 12px;
    padding-right: 30px;
  }
  .test-card-arrow {
    position: absolute;
    top: 24px;
    right: 20px;
    color: var(--primary-light);
    font-size: 1.2rem;
    opacity: 0.4;
    transition: opacity 0.2s;
  }
  .test-card:hover .test-card-arrow { opacity: 1; }
  .test-card-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
  }
  .test-stat {
    text-align: center;
  }
  .test-stat-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
    line-height: 1.2;
  }
  .test-stat-label {
    font-size: 0.75rem;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .dist-bar {
    display: flex;
    height: 24px;
    border-radius: 6px;
    overflow: hidden;
    background: #ecf0f1;
    margin-top: 8px;
  }
  .dist-bar-label {
    font-size: 0.75rem;
    color: #7f8c8d;
    margin-bottom: 4px;
  }
  .dist-seg {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    min-width: 0;
    transition: flex 0.3s;
  }
  .dist-seg.d1 { background: var(--incorrect); }
  .dist-seg.d2 { background: var(--accent); }
  .dist-seg.d3 { background: #f39c12; }
  .dist-seg.d4 { background: var(--correct); }

  /* ========== STATS ROW ========== */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .stat-box {
    background: var(--card);
    border-radius: 10px;
    box-shadow: var(--shadow);
    padding: 18px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .stat-box-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
    line-height: 1.1;
  }
  .stat-box-label {
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ========== TABLES ========== */
  .table-wrap {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
  }
  th {
    background: var(--primary);
    color: white;
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: var(--primary-light); }
  th .sort-arrow { margin-left: 4px; font-size: 0.7rem; opacity: 0.6; }
  th.sorted-asc .sort-arrow::after { content: ' \u25B2'; }
  th.sorted-desc .sort-arrow::after { content: ' \u25BC'; }
  td {
    padding: 9px 14px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  tr:hover td { background: rgba(41,128,185,0.04); }
  tr.row-low td { background: rgba(231,76,60,0.07); }
  tr.row-low:hover td { background: rgba(231,76,60,0.12); }
  .cell-correct { color: var(--correct); font-weight: 700; }
  .cell-incorrect { color: var(--incorrect); font-weight: 700; }
  .cell-written { color: #7f8c8d; font-style: italic; }

  /* ========== BAR CHARTS ========== */
  .bar-chart {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .bar-label {
    width: 140px;
    font-size: 0.82rem;
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .bar-track {
    flex: 1;
    height: 22px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    padding-left: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    min-width: 0;
  }
  .bar-value {
    width: 50px;
    font-size: 0.82rem;
    font-weight: 600;
    text-align: left;
    flex-shrink: 0;
  }

  /* ========== DIFFICULTY BARS ========== */
  .diff-bar {
    height: 18px;
    border-radius: 3px;
    display: inline-block;
    vertical-align: middle;
    transition: width 0.4s ease;
  }
  .diff-easy { background: var(--correct); }
  .diff-medium { background: var(--accent); }
  .diff-hard { background: var(--incorrect); }

  .difficulty-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
  }
  .badge-easy { background: rgba(39,174,96,0.12); color: var(--correct); }
  .badge-medium { background: rgba(230,126,34,0.12); color: var(--accent); }
  .badge-hard { background: rgba(231,76,60,0.12); color: var(--incorrect); }

  /* ========== STUDENT TRACKER ========== */
  .tracker-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
  }
  @media (max-width: 900px) {
    .tracker-grid {
      grid-template-columns: 1fr;
    }
  }
  .student-search-box {
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 100%;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 8px;
  }
  .student-search-box:focus { border-color: var(--primary-light); }
  .student-list {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .student-list-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.15s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .student-list-item:last-child { border-bottom: none; }
  .student-list-item:hover { background: rgba(41,128,185,0.06); }
  .student-list-item.selected { background: rgba(41,128,185,0.12); font-weight: 600; color: var(--primary); }
  .student-list-item .test-count {
    font-size: 0.75rem;
    background: #ecf0f1;
    padding: 2px 8px;
    border-radius: 10px;
    color: #7f8c8d;
  }

  .profile-card { min-height: 200px; }
  .profile-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .profile-stat {
    text-align: center;
    padding: 14px;
    background: var(--bg);
    border-radius: 8px;
  }
  .profile-stat-value {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--primary);
    line-height: 1.1;
  }
  .profile-stat-label {
    font-size: 0.75rem;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }
  .trend-up { color: var(--correct) !important; }
  .trend-down { color: var(--incorrect) !important; }
  .trend-stable { color: var(--accent) !important; }

  .chart-container {
    position: relative;
    width: 100%;
    height: 260px;
    margin-bottom: 20px;
  }
  .chart-container canvas {
    width: 100%;
    height: 100%;
  }

  /* ========== CLASS SUMMARY ========== */
  .class-section { margin-top: 24px; }
  .class-row {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
  }
  .class-dropdown {
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    outline: none;
    background: white;
    min-width: 180px;
  }

  /* ========== DROPDOWN SELECTS ========== */
  .select-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .select-wrap label {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--primary);
  }
  .select-wrap select {
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    outline: none;
    background: white;
    min-width: 260px;
    cursor: pointer;
  }
  .select-wrap select:focus { border-color: var(--primary-light); }

  /* ========== LOADING / EMPTY STATES ========== */
  .state-message {
    text-align: center;
    padding: 60px 24px;
    color: #95a5a6;
  }
  .state-message .state-icon { font-size: 3rem; margin-bottom: 16px; }
  .state-message h3 { font-size: 1.2rem; color: #7f8c8d; margin-bottom: 8px; }
  .state-message p { font-size: 0.9rem; }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #ecf0f1;
    border-top: 4px solid var(--primary-light);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    background: rgba(231,76,60,0.08);
    border: 1px solid rgba(231,76,60,0.2);
    color: var(--incorrect);
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 0.9rem;
    margin-bottom: 16px;
  }

  /* ========== PRINT BUTTON ========== */
  .print-btn-wrap {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 12px;
  }

  /* ========== PRINT STYLES ========== */
  @media print {
    .top-bar, .settings-bar, .tab-nav, .print-btn-wrap, .btn-settings, .select-wrap, .no-print {
      display: none !important;
    }
    body { background: white; }
    .main-content { max-width: 100%; padding: 0; margin: 0; }
    .tab-panel { display: block !important; page-break-before: auto; }
    .tab-panel:not(.print-target) { display: none !important; }
    .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
    .stat-box { box-shadow: none; border: 1px solid #ccc; }
    .table-wrap { overflow: visible; }
    th { position: static; }
    .bar-fill { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .diff-bar { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .dist-seg { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .difficulty-badge { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .cell-correct, .cell-incorrect { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    tr.row-low td { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    .chart-container { break-inside: avoid; }
    h2.print-title { display: block !important; font-size: 1.4rem; color: var(--primary); margin-bottom: 16px; font-weight: 700; }
  }
  h2.print-title { display: none; }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 768px) {
    .top-bar { padding: 12px 16px; flex-wrap: wrap; gap: 8px; }
    .top-bar h1 { font-size: 1.1rem; }
    .main-content { padding: 16px; }
    .tab-btn { padding: 10px 14px; font-size: 0.85rem; }
    .tab-btn .tab-text { display: none; }
    .tab-btn .tab-icon { font-size: 1.3rem; }
    .test-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .bar-label { width: 90px; font-size: 0.75rem; }
    .settings-bar.open { max-height: 160px; }
    .settings-inner { flex-direction: column; align-items: stretch; }
    .settings-bar input[type="text"] { min-width: 100%; }
  }

  /* ========== SCROLLBAR ========== */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
  ::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #95a5a6; }
</style>
</head>
<body>

<!-- ==================== TOP BAR ==================== -->
<div class="top-bar">
  <div>
    <h1><span class="icon">&#128202;</span> Results Analyser</h1>
  </div>
  <div class="top-bar-right">
    <span class="last-loaded" id="lastLoadedDisplay"></span>
    <button class="btn-settings" id="toggleSettingsBtn" onclick="toggleSettings()">
      <span>&#9881;</span> Settings
    </button>
  </div>
</div>

<!-- ==================== SETTINGS BAR ==================== -->
<div class="settings-bar" id="settingsBar">
  <div class="settings-inner">
    <label for="sheetUrlInput">Web App URL:</label>
    <input type="text" id="sheetUrlInput" placeholder="https://script.google.com/macros/s/.../exec">
    <button class="btn btn-accent" id="loadBtn" onclick="loadData()">
      <span>&#8635;</span> Load Results
    </button>
    <button class="btn btn-outline" onclick="clearData()">Clear</button>
  </div>
</div>

<!-- ==================== TAB NAVIGATION ==================== -->
<div class="tab-nav" id="tabNav">
  <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
    <span class="tab-icon">&#128203;</span>
    <span class="tab-text">Test Overview</span>
  </button>
  <button class="tab-btn" data-tab="analysis" onclick="switchTab('analysis')">
    <span class="tab-icon">&#128200;</span>
    <span class="tab-text">Test Analysis</span>
  </button>
  <button class="tab-btn" data-tab="tracker" onclick="switchTab('tracker')">
    <span class="tab-icon">&#128100;</span>
    <span class="tab-text">Student Tracker</span>
  </button>
</div>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="main-content">
  <div id="errorArea"></div>

  <!-- ========== TAB 1: TEST OVERVIEW ========== -->
  <div class="tab-panel active" id="panel-overview">
    <div id="overviewContent">
      <div class="state-message" id="overviewEmpty">
        <div class="state-icon">&#128202;</div>
        <h3>No data loaded</h3>
        <p>Click the Settings button above and enter your Google Sheets Web App URL to get started.</p>
      </div>
    </div>
  </div>

  <!-- ========== TAB 2: TEST ANALYSIS ========== -->
  <div class="tab-panel" id="panel-analysis">
    <h2 class="print-title" id="analysisPrintTitle">Test Analysis Report</h2>
    <div id="analysisContent">
      <div class="state-message" id="analysisEmpty">
        <div class="state-icon">&#128200;</div>
        <h3>No data loaded</h3>
        <p>Load your results data to analyse individual tests.</p>
      </div>
    </div>
  </div>

  <!-- ========== TAB 3: STUDENT TRACKER ========== -->
  <div class="tab-panel" id="panel-tracker">
    <div id="trackerContent">
      <div class="state-message" id="trackerEmpty">
        <div class="state-icon">&#128100;</div>
        <h3>No data loaded</h3>
        <p>Load your results data to track student progress across tests.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* ================================================================
   GLOBALS
   ================================================================ */
let appData = null;
let currentTab = 'overview';

/* ================================================================
   SETTINGS
   ================================================================ */
function toggleSettings() {
  document.getElementById('settingsBar').classList.toggle('open');
}

function saveUrl(url) {
  try { localStorage.setItem('naplan_sheet_url', url); } catch(e) {}
}

function getSavedUrl() {
  try { return localStorage.getItem('naplan_sheet_url') || ''; } catch(e) { return ''; }
}

function saveLastLoaded() {
  var now = new Date().toLocaleString();
  try { localStorage.setItem('naplan_last_loaded', now); } catch(e) {}
  document.getElementById('lastLoadedDisplay').textContent = 'Last loaded: ' + now;
}

function restoreLastLoaded() {
  try {
    var t = localStorage.getItem('naplan_last_loaded');
    if (t) document.getElementById('lastLoadedDisplay').textContent = 'Last loaded: ' + t;
  } catch(e) {}
}

/* ================================================================
   DATA LOADING
   ================================================================ */
function showError(msg) {
  document.getElementById('errorArea').innerHTML = '<div class="error-msg">' + escapeHtml(msg) + '</div>';
}

function clearError() {
  document.getElementById('errorArea').innerHTML = '';
}

function loadData() {
  var url = document.getElementById('sheetUrlInput').value.trim();
  if (!url) {
    showError('Please enter a Google Sheets Web App URL.');
    return;
  }
  saveUrl(url);
  clearError();

  var btn = document.getElementById('loadBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;display:inline-block;vertical-align:middle;"></span> Loading...';

  showLoadingState();

  fetch(url, { redirect: 'follow' })
    .then(function(r) {
      if (!r.ok) throw new Error('HTTP error ' + r.status);
      return r.json();
    })
    .then(function(data) {
      if (!data || !data.tests || !Array.isArray(data.tests)) {
        throw new Error('Invalid data format. Expected { tests: [...] }');
      }
      appData = data;
      saveLastLoaded();
      renderAll();
    })
    .catch(function(err) {
      showError('Failed to load data: ' + err.message);
      showEmptyStates();
    })
    .finally(function() {
      btn.disabled = false;
      btn.innerHTML = '<span>&#8635;</span> Load Results';
    });
}

function clearData() {
  appData = null;
  try {
    localStorage.removeItem('naplan_sheet_url');
    localStorage.removeItem('naplan_last_loaded');
  } catch(e) {}
  document.getElementById('sheetUrlInput').value = '';
  document.getElementById('lastLoadedDisplay').textContent = '';
  showEmptyStates();
  clearError();
}

function showLoadingState() {
  var html = '<div class="state-message"><div class="spinner"></div><h3>Loading data...</h3></div>';
  document.getElementById('overviewContent').innerHTML = html;
  document.getElementById('analysisContent').innerHTML = html;
  document.getElementById('trackerContent').innerHTML = html;
}

function showEmptyStates() {
  document.getElementById('overviewContent').innerHTML =
    '<div class="state-message" id="overviewEmpty"><div class="state-icon">&#128202;</div><h3>No data loaded</h3><p>Click the Settings button above and enter your Google Sheets Web App URL to get started.</p></div>';
  document.getElementById('analysisContent').innerHTML =
    '<div class="state-message" id="analysisEmpty"><div class="state-icon">&#128200;</div><h3>No data loaded</h3><p>Load your results data to analyse individual tests.</p></div>';
  document.getElementById('trackerContent').innerHTML =
    '<div class="state-message" id="trackerEmpty"><div class="state-icon">&#128100;</div><h3>No data loaded</h3><p>Load your results data to track student progress across tests.</p></div>';
}

/* ================================================================
   TAB SWITCHING
   ================================================================ */
function switchTab(tab) {
  currentTab = tab;
  var btns = document.querySelectorAll('.tab-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.toggle('active', btns[i].getAttribute('data-tab') === tab);
  }
  var panels = document.querySelectorAll('.tab-panel');
  for (var i = 0; i < panels.length; i++) {
    panels[i].classList.toggle('active', panels[i].id === 'panel-' + tab);
  }
}

/* ================================================================
   PARSING UTILITIES
   ================================================================ */
function parseQCell(cell) {
  var str = String(cell);
  if (str.startsWith('\u2713')) {
    return { correct: true, answered: str.replace('\u2713', '').trim() };
  }
  if (str.startsWith('\u2717')) {
    var match = str.match(/\u2717\s*(\S+)\s*\((\S+)\)/);
    if (match) return { correct: false, answered: match[1], correctAnswer: match[2] };
    return { correct: false, answered: '-', correctAnswer: '' };
  }
  if (str === 'See written') return { correct: null, type: 'written' };
  return { correct: null };
}

function getQColumns(headers) {
  var cols = [];
  for (var i = 0; i < headers.length; i++) {
    if (/^Q\d+$/i.test(headers[i])) {
      cols.push({ index: i, name: headers[i] });
    }
  }
  return cols;
}

function getColIndex(headers, name) {
  for (var i = 0; i < headers.length; i++) {
    if (headers[i].toLowerCase() === name.toLowerCase()) return i;
  }
  return -1;
}

function parsePercentage(val) {
  if (typeof val === 'number') return val;
  var str = String(val).replace('%', '').trim();
  var n = parseFloat(str);
  return isNaN(n) ? 0 : n;
}

function parseScore(val) {
  var n = parseFloat(String(val));
  return isNaN(n) ? 0 : n;
}

function escapeHtml(str) {
  var d = document.createElement('div');
  d.appendChild(document.createTextNode(String(str)));
  return d.innerHTML;
}

function median(arr) {
  if (arr.length === 0) return 0;
  var sorted = arr.slice().sort(function(a, b) { return a - b; });
  var mid = Math.floor(sorted.length / 2);
  if (sorted.length % 2 === 0) return (sorted[mid - 1] + sorted[mid]) / 2;
  return sorted[mid];
}

/* ================================================================
   RENDER ALL
   ================================================================ */
function renderAll() {
  if (!appData || !appData.tests) return;
  renderOverview();
  renderAnalysis();
  renderTracker();
}

/* ================================================================
   TAB 1: TEST OVERVIEW
   ================================================================ */
function renderOverview() {
  var tests = appData.tests;
  if (!tests || tests.length === 0) {
    document.getElementById('overviewContent').innerHTML =
      '<div class="state-message"><div class="state-icon">&#128203;</div><h3>No tests found</h3><p>The data source returned no tests.</p></div>';
    return;
  }

  var html = '<div class="test-grid">';

  for (var t = 0; t < tests.length; t++) {
    var test = tests[t];
    var rows = test.rows || [];
    var headers = test.headers || [];
    var pctIdx = getColIndex(headers, 'Percentage');
    var numStudents = rows.length;

    var percentages = [];
    for (var r = 0; r < rows.length; r++) {
      if (pctIdx >= 0 && pctIdx < rows[r].length) {
        percentages.push(parsePercentage(rows[r][pctIdx]));
      }
    }

    var avg = 0;
    if (percentages.length > 0) {
      var sum = 0;
      for (var i = 0; i < percentages.length; i++) sum += percentages[i];
      avg = sum / percentages.length;
    }

    var dist = [0, 0, 0, 0];
    for (var i = 0; i < percentages.length; i++) {
      var p = percentages[i];
      if (p <= 25) dist[0]++;
      else if (p <= 50) dist[1]++;
      else if (p <= 75) dist[2]++;
      else dist[3]++;
    }

    var total = Math.max(numStudents, 1);
    var d1 = (dist[0] / total * 100).toFixed(1);
    var d2 = (dist[1] / total * 100).toFixed(1);
    var d3 = (dist[2] / total * 100).toFixed(1);
    var d4 = (dist[3] / total * 100).toFixed(1);

    html += '<div class="test-card" onclick="drillIntoTest(' + t + ')">';
    html += '<div class="test-card-name">' + escapeHtml(test.name) + '</div>';
    html += '<div class="test-card-arrow">&#8594;</div>';
    html += '<div class="test-card-stats">';
    html += '<div class="test-stat"><div class="test-stat-value">' + numStudents + '</div><div class="test-stat-label">Students</div></div>';
    html += '<div class="test-stat"><div class="test-stat-value">' + avg.toFixed(1) + '%</div><div class="test-stat-label">Average</div></div>';
    html += '</div>';
    html += '<div class="dist-bar-label">Score Distribution</div>';
    html += '<div class="dist-bar">';
    if (dist[0] > 0) html += '<div class="dist-seg d1" style="flex:' + d1 + '" title="0-25%: ' + dist[0] + ' students">' + (dist[0] > 0 && parseFloat(d1) > 10 ? dist[0] : '') + '</div>';
    if (dist[1] > 0) html += '<div class="dist-seg d2" style="flex:' + d2 + '" title="26-50%: ' + dist[1] + ' students">' + (dist[1] > 0 && parseFloat(d2) > 10 ? dist[1] : '') + '</div>';
    if (dist[2] > 0) html += '<div class="dist-seg d3" style="flex:' + d3 + '" title="51-75%: ' + dist[2] + ' students">' + (dist[2] > 0 && parseFloat(d3) > 10 ? dist[2] : '') + '</div>';
    if (dist[3] > 0) html += '<div class="dist-seg d4" style="flex:' + d4 + '" title="76-100%: ' + dist[3] + ' students">' + (dist[3] > 0 && parseFloat(d4) > 10 ? dist[3] : '') + '</div>';
    html += '</div>';
    html += '</div>';
  }

  html += '</div>';
  document.getElementById('overviewContent').innerHTML = html;
}

function drillIntoTest(index) {
  switchTab('analysis');
  var sel = document.getElementById('testSelect');
  if (sel) {
    sel.value = index;
    renderTestAnalysis(index);
  }
}

/* ================================================================
   TAB 2: TEST ANALYSIS
   ================================================================ */
function renderAnalysis() {
  var tests = appData.tests;
  if (!tests || tests.length === 0) {
    document.getElementById('analysisContent').innerHTML =
      '<div class="state-message"><div class="state-icon">&#128200;</div><h3>No tests found</h3></div>';
    return;
  }

  var html = '';
  html += '<div class="print-btn-wrap no-print"><button class="btn btn-primary btn-sm" onclick="printAnalysis()">&#128424; Print Report</button></div>';
  html += '<div class="select-wrap no-print">';
  html += '<label for="testSelect">Select Test:</label>';
  html += '<select id="testSelect" onchange="renderTestAnalysis(this.value)">';
  for (var i = 0; i < tests.length; i++) {
    html += '<option value="' + i + '">' + escapeHtml(tests[i].name) + '</option>';
  }
  html += '</select></div>';
  html += '<div id="testAnalysisBody"></div>';

  document.getElementById('analysisContent').innerHTML = html;
  renderTestAnalysis(0);
}

function renderTestAnalysis(idx) {
  idx = parseInt(idx);
  var test = appData.tests[idx];
  if (!test) return;

  document.getElementById('analysisPrintTitle').textContent = test.name + ' - Analysis Report';

  var headers = test.headers || [];
  var rows = test.rows || [];
  var pctIdx = getColIndex(headers, 'Percentage');
  var scoreIdx = getColIndex(headers, 'Score');
  var nameIdx = getColIndex(headers, 'Student Name');
  var classIdx = getColIndex(headers, 'Class');
  var totalQIdx = getColIndex(headers, 'Total Questions');
  var qCols = getQColumns(headers);

  var percentages = [];
  var scores = [];
  for (var r = 0; r < rows.length; r++) {
    percentages.push(pctIdx >= 0 ? parsePercentage(rows[r][pctIdx]) : 0);
    scores.push(scoreIdx >= 0 ? parseScore(rows[r][scoreIdx]) : 0);
  }

  var numStudents = rows.length;
  var avg = 0, med = 0, highest = 0, lowest = 0;
  if (percentages.length > 0) {
    var sum = 0;
    for (var i = 0; i < percentages.length; i++) sum += percentages[i];
    avg = sum / percentages.length;
    med = median(percentages);
    highest = Math.max.apply(null, percentages);
    lowest = Math.min.apply(null, percentages);
  }

  var html = '';

  /* Score Summary */
  html += '<div class="stats-row">';
  html += '<div class="stat-box"><div class="stat-box-value">' + avg.toFixed(1) + '%</div><div class="stat-box-label">Average</div></div>';
  html += '<div class="stat-box"><div class="stat-box-value">' + med.toFixed(1) + '%</div><div class="stat-box-label">Median</div></div>';
  html += '<div class="stat-box"><div class="stat-box-value">' + highest.toFixed(1) + '%</div><div class="stat-box-label">Highest</div></div>';
  html += '<div class="stat-box"><div class="stat-box-value">' + lowest.toFixed(1) + '%</div><div class="stat-box-label">Lowest</div></div>';
  html += '<div class="stat-box"><div class="stat-box-value">' + numStudents + '</div><div class="stat-box-label">Students</div></div>';
  html += '</div>';

  /* Score Bar Chart */
  html += '<div class="card">';
  html += '<div class="card-title">&#128202; Student Scores</div>';

  var studentScores = [];
  for (var r = 0; r < rows.length; r++) {
    studentScores.push({
      name: nameIdx >= 0 ? String(rows[r][nameIdx]) : 'Student ' + (r + 1),
      pct: percentages[r]
    });
  }
  studentScores.sort(function(a, b) { return b.pct - a.pct; });

  html += '<div class="bar-chart">';
  for (var i = 0; i < studentScores.length; i++) {
    var color = studentScores[i].pct >= 70 ? 'var(--correct)' : studentScores[i].pct >= 40 ? 'var(--accent)' : 'var(--incorrect)';
    html += '<div class="bar-row">';
    html += '<div class="bar-label" title="' + escapeHtml(studentScores[i].name) + '">' + escapeHtml(studentScores[i].name) + '</div>';
    html += '<div class="bar-track"><div class="bar-fill" style="width:' + Math.max(studentScores[i].pct, 1) + '%;background:' + color + '">' + (studentScores[i].pct > 12 ? studentScores[i].pct.toFixed(0) + '%' : '') + '</div></div>';
    html += '<div class="bar-value">' + studentScores[i].pct.toFixed(1) + '%</div>';
    html += '</div>';
  }
  html += '</div></div>';

  /* Question Difficulty Table */
  html += '<div class="card">';
  html += '<div class="card-title">&#127919; Question Difficulty</div>';

  var qStats = [];
  for (var q = 0; q < qCols.length; q++) {
    var col = qCols[q];
    var total = 0, correct = 0;
    var wrongAnswers = {};

    for (var r = 0; r < rows.length; r++) {
      var cellVal = col.index < rows[r].length ? rows[r][col.index] : '';
      var parsed = parseQCell(cellVal);
      if (parsed.correct === true) {
        total++;
        correct++;
      } else if (parsed.correct === false) {
        total++;
        var wa = parsed.answered || '-';
        wrongAnswers[wa] = (wrongAnswers[wa] || 0) + 1;
      }
    }

    var pctCorrect = total > 0 ? (correct / total * 100) : 0;
    var mostCommonWrong = '-';
    var maxWrongCount = 0;
    for (var wa in wrongAnswers) {
      if (wrongAnswers[wa] > maxWrongCount) {
        maxWrongCount = wrongAnswers[wa];
        mostCommonWrong = wa;
      }
    }

    qStats.push({
      name: col.name,
      pctCorrect: pctCorrect,
      mostCommonWrong: mostCommonWrong,
      wrongCount: maxWrongCount,
      total: total
    });
  }

  qStats.sort(function(a, b) { return a.pctCorrect - b.pctCorrect; });

  html += '<div class="table-wrap"><table>';
  html += '<thead><tr><th>Question</th><th>% Correct</th><th style="min-width:180px">Correct Rate</th><th>Most Common Wrong</th><th>Difficulty</th></tr></thead>';
  html += '<tbody>';
  for (var i = 0; i < qStats.length; i++) {
    var qs = qStats[i];
    var diffClass, diffLabel;
    if (qs.pctCorrect < 40) { diffClass = 'hard'; diffLabel = 'Hard'; }
    else if (qs.pctCorrect <= 70) { diffClass = 'medium'; diffLabel = 'Medium'; }
    else { diffClass = 'easy'; diffLabel = 'Easy'; }

    html += '<tr>';
    html += '<td><strong>' + escapeHtml(qs.name) + '</strong></td>';
    html += '<td>' + qs.pctCorrect.toFixed(1) + '%</td>';
    html += '<td><div class="diff-bar diff-' + diffClass + '" style="width:' + Math.max(qs.pctCorrect, 2) + '%"></div></td>';
    html += '<td>' + escapeHtml(qs.mostCommonWrong) + (qs.wrongCount > 0 ? ' (' + qs.wrongCount + ')' : '') + '</td>';
    html += '<td><span class="difficulty-badge badge-' + diffClass + '">' + diffLabel + '</span></td>';
    html += '</tr>';
  }
  html += '</tbody></table></div></div>';

  /* Student Results Table */
  html += '<div class="card">';
  html += '<div class="card-title">&#128209; Student Results</div>';
  html += '<div class="table-wrap"><table id="studentResultsTable">';
  html += '<thead><tr>';
  html += '<th class="sortable" data-col="name" onclick="sortStudentResults(\'' + idx + '\', \'name\')">Name <span class="sort-arrow"></span></th>';
  html += '<th class="sortable" data-col="class" onclick="sortStudentResults(\'' + idx + '\', \'class\')">Class <span class="sort-arrow"></span></th>';
  html += '<th class="sortable" data-col="score" onclick="sortStudentResults(\'' + idx + '\', \'score\')">Score <span class="sort-arrow"></span></th>';
  html += '<th class="sortable" data-col="pct" onclick="sortStudentResults(\'' + idx + '\', \'pct\')">% <span class="sort-arrow"></span></th>';
  for (var q = 0; q < qCols.length; q++) {
    html += '<th style="text-align:center;min-width:36px">' + escapeHtml(qCols[q].name) + '</th>';
  }
  html += '</tr></thead>';
  html += '<tbody id="studentResultsBody">';

  var studentData = [];
  for (var r = 0; r < rows.length; r++) {
    studentData.push({
      name: nameIdx >= 0 ? String(rows[r][nameIdx]) : '',
      className: classIdx >= 0 ? String(rows[r][classIdx]) : '',
      score: scoreIdx >= 0 ? parseScore(rows[r][scoreIdx]) : 0,
      pct: percentages[r],
      rowIdx: r
    });
  }

  html += buildStudentResultsRows(studentData, rows, qCols);
  html += '</tbody></table></div></div>';

  document.getElementById('testAnalysisBody').innerHTML = html;

  window._currentTestIdx = idx;
  window._currentStudentData = studentData;
  window._currentSortCol = null;
  window._currentSortDir = 'asc';
}

function buildStudentResultsRows(studentData, rows, qCols) {
  var html = '';
  for (var i = 0; i < studentData.length; i++) {
    var sd = studentData[i];
    var rowClass = sd.pct < 50 ? ' class="row-low"' : '';
    html += '<tr' + rowClass + '>';
    html += '<td>' + escapeHtml(sd.name) + '</td>';
    html += '<td>' + escapeHtml(sd.className) + '</td>';
    html += '<td>' + sd.score + '</td>';
    html += '<td><strong>' + sd.pct.toFixed(1) + '%</strong></td>';

    var row = rows[sd.rowIdx];
    for (var q = 0; q < qCols.length; q++) {
      var cellVal = qCols[q].index < row.length ? row[qCols[q].index] : '';
      var parsed = parseQCell(cellVal);
      if (parsed.correct === true) {
        html += '<td style="text-align:center" class="cell-correct" title="' + escapeHtml(String(cellVal)) + '">\u2713</td>';
      } else if (parsed.correct === false) {
        html += '<td style="text-align:center" class="cell-incorrect" title="' + escapeHtml(String(cellVal)) + '">\u2717</td>';
      } else if (parsed.type === 'written') {
        html += '<td style="text-align:center" class="cell-written" title="See written">\u270E</td>';
      } else {
        html += '<td style="text-align:center">-</td>';
      }
    }
    html += '</tr>';
  }
  return html;
}

function sortStudentResults(testIdx, col) {
  testIdx = parseInt(testIdx);
  var test = appData.tests[testIdx];
  if (!test) return;

  var headers = test.headers || [];
  var rows = test.rows || [];
  var pctIdx = getColIndex(headers, 'Percentage');
  var scoreIdx = getColIndex(headers, 'Score');
  var nameIdx = getColIndex(headers, 'Student Name');
  var classIdx = getColIndex(headers, 'Class');
  var qCols = getQColumns(headers);

  var percentages = [];
  for (var r = 0; r < rows.length; r++) {
    percentages.push(pctIdx >= 0 ? parsePercentage(rows[r][pctIdx]) : 0);
  }

  var studentData = [];
  for (var r = 0; r < rows.length; r++) {
    studentData.push({
      name: nameIdx >= 0 ? String(rows[r][nameIdx]) : '',
      className: classIdx >= 0 ? String(rows[r][classIdx]) : '',
      score: scoreIdx >= 0 ? parseScore(rows[r][scoreIdx]) : 0,
      pct: percentages[r],
      rowIdx: r
    });
  }

  if (window._currentSortCol === col) {
    window._currentSortDir = window._currentSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    window._currentSortCol = col;
    window._currentSortDir = col === 'score' || col === 'pct' ? 'desc' : 'asc';
  }

  var dir = window._currentSortDir === 'asc' ? 1 : -1;
  studentData.sort(function(a, b) {
    var va, vb;
    if (col === 'name') { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }
    else if (col === 'class') { va = a.className.toLowerCase(); vb = b.className.toLowerCase(); }
    else if (col === 'score') { va = a.score; vb = b.score; }
    else if (col === 'pct') { va = a.pct; vb = b.pct; }
    else { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }

    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });

  var tbody = document.getElementById('studentResultsBody');
  if (tbody) {
    tbody.innerHTML = buildStudentResultsRows(studentData, rows, qCols);
  }

  var ths = document.querySelectorAll('#studentResultsTable th.sortable');
  for (var i = 0; i < ths.length; i++) {
    ths[i].classList.remove('sorted-asc', 'sorted-desc');
    if (ths[i].getAttribute('data-col') === col) {
      ths[i].classList.add(window._currentSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
    }
  }
}

function printAnalysis() {
  var panels = document.querySelectorAll('.tab-panel');
  for (var i = 0; i < panels.length; i++) {
    panels[i].classList.remove('print-target');
  }
  document.getElementById('panel-analysis').classList.add('print-target');
  window.print();
}

/* ================================================================
   TAB 3: STUDENT TRACKER
   ================================================================ */
function renderTracker() {
  var tests = appData.tests;
  if (!tests || tests.length === 0) {
    document.getElementById('trackerContent').innerHTML =
      '<div class="state-message"><div class="state-icon">&#128100;</div><h3>No tests found</h3></div>';
    return;
  }

  /* Gather all unique students and classes */
  var studentMap = {};
  var classSet = {};
  for (var t = 0; t < tests.length; t++) {
    var headers = tests[t].headers || [];
    var rows = tests[t].rows || [];
    var nameIdx = getColIndex(headers, 'Student Name');
    var classIdx = getColIndex(headers, 'Class');
    var pctIdx = getColIndex(headers, 'Percentage');
    var scoreIdx = getColIndex(headers, 'Score');
    var tsIdx = getColIndex(headers, 'Timestamp');

    for (var r = 0; r < rows.length; r++) {
      var name = nameIdx >= 0 ? String(rows[r][nameIdx]).trim() : '';
      var cls = classIdx >= 0 ? String(rows[r][classIdx]).trim() : '';
      if (!name) continue;

      if (!studentMap[name]) {
        studentMap[name] = { name: name, classes: {}, tests: [] };
      }
      if (cls) {
        studentMap[name].classes[cls] = true;
        classSet[cls] = true;
      }

      studentMap[name].tests.push({
        testIndex: t,
        testName: tests[t].name,
        pct: pctIdx >= 0 ? parsePercentage(rows[r][pctIdx]) : 0,
        score: scoreIdx >= 0 ? parseScore(rows[r][scoreIdx]) : 0,
        timestamp: tsIdx >= 0 ? String(rows[r][tsIdx]) : ''
      });
    }
  }

  var studentNames = Object.keys(studentMap).sort(function(a, b) {
    return a.toLowerCase().localeCompare(b.toLowerCase());
  });
  var classNames = Object.keys(classSet).sort();

  var html = '<div class="tracker-grid">';

  /* Left: Student selector */
  html += '<div>';
  html += '<div class="card">';
  html += '<div class="card-title">&#128269; Find Student</div>';
  html += '<input type="text" class="student-search-box" id="studentSearchInput" placeholder="Search students..." oninput="filterStudentList()">';
  html += '<div class="student-list" id="studentListContainer">';
  for (var i = 0; i < studentNames.length; i++) {
    var s = studentMap[studentNames[i]];
    html += '<div class="student-list-item" data-name="' + escapeHtml(studentNames[i]) + '" onclick="selectStudent(\'' + escapeHtml(studentNames[i]).replace(/'/g, "\\'") + '\')">';
    html += '<span>' + escapeHtml(studentNames[i]) + '</span>';
    html += '<span class="test-count">' + s.tests.length + ' test' + (s.tests.length !== 1 ? 's' : '') + '</span>';
    html += '</div>';
  }
  html += '</div></div></div>';

  /* Right: Profile + Class Summary */
  html += '<div>';
  html += '<div id="studentProfileArea">';
  html += '<div class="card"><div class="state-message" style="padding:40px"><div class="state-icon">&#128100;</div><h3>Select a student</h3><p>Choose a student from the list to view their progress across tests.</p></div></div>';
  html += '</div>';

  /* Class Summary */
  html += '<div class="class-section">';
  html += '<div class="card">';
  html += '<div class="card-title">&#127979; Class Summary</div>';
  html += '<div class="class-row">';
  html += '<label for="classSummarySelect" style="font-weight:600;font-size:0.9rem;">Class:</label>';
  html += '<select class="class-dropdown" id="classSummarySelect" onchange="renderClassSummary()">';
  html += '<option value="">-- Select a class --</option>';
  for (var i = 0; i < classNames.length; i++) {
    html += '<option value="' + escapeHtml(classNames[i]) + '">' + escapeHtml(classNames[i]) + '</option>';
  }
  html += '</select></div>';
  html += '<div id="classSummaryBody"></div>';
  html += '</div></div>';

  html += '</div>';
  html += '</div>';

  document.getElementById('trackerContent').innerHTML = html;

  window._studentMap = studentMap;
  window._classNames = classNames;
}

function filterStudentList() {
  var query = document.getElementById('studentSearchInput').value.toLowerCase().trim();
  var items = document.querySelectorAll('#studentListContainer .student-list-item');
  for (var i = 0; i < items.length; i++) {
    var name = items[i].getAttribute('data-name').toLowerCase();
    items[i].style.display = (query === '' || name.indexOf(query) >= 0) ? '' : 'none';
  }
}

function selectStudent(name) {
  var items = document.querySelectorAll('#studentListContainer .student-list-item');
  for (var i = 0; i < items.length; i++) {
    items[i].classList.toggle('selected', items[i].getAttribute('data-name') === name);
  }

  var student = window._studentMap[name];
  if (!student) return;

  var tests = student.tests;
  var totalTests = tests.length;

  var avgPct = 0;
  if (totalTests > 0) {
    var sum = 0;
    for (var i = 0; i < tests.length; i++) sum += tests[i].pct;
    avgPct = sum / totalTests;
  }

  /* Determine trend */
  var trend = 'stable';
  var trendClass = 'trend-stable';
  var trendIcon = '\u2194';
  if (totalTests >= 2) {
    var half = Math.ceil(totalTests / 2);
    var firstSum = 0, secondSum = 0;
    for (var i = 0; i < half; i++) firstSum += tests[i].pct;
    for (var i = half; i < totalTests; i++) secondSum += tests[i].pct;
    var firstAvg = firstSum / half;
    var secondAvg = secondSum / (totalTests - half);
    var diff = secondAvg - firstAvg;
    if (diff > 3) { trend = 'Improving'; trendClass = 'trend-up'; trendIcon = '\u2191'; }
    else if (diff < -3) { trend = 'Declining'; trendClass = 'trend-down'; trendIcon = '\u2193'; }
    else { trend = 'Stable'; trendClass = 'trend-stable'; trendIcon = '\u2194'; }
  }

  var classes = Object.keys(student.classes).join(', ') || '-';

  var html = '<div class="card profile-card">';
  html += '<div class="card-title">&#128100; ' + escapeHtml(name) + ' <span style="font-weight:400;font-size:0.85rem;color:#7f8c8d;margin-left:8px">' + escapeHtml(classes) + '</span></div>';

  html += '<div class="profile-stats">';
  html += '<div class="profile-stat"><div class="profile-stat-value">' + totalTests + '</div><div class="profile-stat-label">Tests Taken</div></div>';
  html += '<div class="profile-stat"><div class="profile-stat-value">' + avgPct.toFixed(1) + '%</div><div class="profile-stat-label">Average</div></div>';
  html += '<div class="profile-stat"><div class="profile-stat-value ' + trendClass + '">' + trendIcon + ' ' + trend + '</div><div class="profile-stat-label">Trend</div></div>';
  html += '</div>';

  /* Line chart */
  if (totalTests >= 2) {
    html += '<div class="chart-container"><canvas id="studentLineChart"></canvas></div>';
  }

  /* Test history table */
  html += '<div class="table-wrap"><table>';
  html += '<thead><tr><th>Test Name</th><th>Date</th><th>Score</th><th>Percentage</th></tr></thead>';
  html += '<tbody>';
  for (var i = 0; i < tests.length; i++) {
    var t = tests[i];
    var dateStr = t.timestamp ? t.timestamp.split(',')[0] : '-';
    html += '<tr>';
    html += '<td>' + escapeHtml(t.testName) + '</td>';
    html += '<td>' + escapeHtml(dateStr) + '</td>';
    html += '<td>' + t.score + '</td>';
    html += '<td><strong>' + t.pct.toFixed(1) + '%</strong></td>';
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  html += '</div>';

  document.getElementById('studentProfileArea').innerHTML = html;

  /* Draw line chart */
  if (totalTests >= 2) {
    var canvas = document.getElementById('studentLineChart');
    if (canvas) {
      var dataPoints = [];
      var labels = [];
      for (var i = 0; i < tests.length; i++) {
        dataPoints.push(tests[i].pct);
        labels.push(tests[i].testName);
      }
      drawLineChart(canvas, dataPoints, labels);
    }
  }
}

/* ================================================================
   LINE CHART (Canvas)
   ================================================================ */
function drawLineChart(canvas, dataPoints, labels) {
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.parentElement.getBoundingClientRect();
  var w = rect.width;
  var h = rect.height;

  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';

  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  var padLeft = 50;
  var padRight = 20;
  var padTop = 20;
  var padBottom = 60;
  var chartW = w - padLeft - padRight;
  var chartH = h - padTop - padBottom;

  /* Background */
  ctx.fillStyle = '#fafbfc';
  ctx.fillRect(0, 0, w, h);

  /* Grid lines */
  ctx.strokeStyle = '#ecf0f1';
  ctx.lineWidth = 1;
  ctx.font = '11px Segoe UI, system-ui, sans-serif';
  ctx.fillStyle = '#95a5a6';
  ctx.textAlign = 'right';

  for (var val = 0; val <= 100; val += 20) {
    var y = padTop + chartH - (val / 100 * chartH);
    ctx.beginPath();
    ctx.moveTo(padLeft, y);
    ctx.lineTo(padLeft + chartW, y);
    ctx.stroke();
    ctx.fillText(val + '%', padLeft - 8, y + 4);
  }

  if (dataPoints.length < 2) return;

  /* Calculate points */
  var points = [];
  var step = dataPoints.length > 1 ? chartW / (dataPoints.length - 1) : 0;
  for (var i = 0; i < dataPoints.length; i++) {
    var x = padLeft + i * step;
    var y = padTop + chartH - (Math.min(Math.max(dataPoints[i], 0), 100) / 100 * chartH);
    points.push({ x: x, y: y });
  }

  /* Draw line */
  ctx.beginPath();
  ctx.strokeStyle = '#2980b9';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.moveTo(points[0].x, points[0].y);
  for (var i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }
  ctx.stroke();

  /* Draw area fill */
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (var i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }
  ctx.lineTo(points[points.length - 1].x, padTop + chartH);
  ctx.lineTo(points[0].x, padTop + chartH);
  ctx.closePath();
  ctx.fillStyle = 'rgba(41, 128, 185, 0.08)';
  ctx.fill();

  /* Draw dots */
  for (var i = 0; i < points.length; i++) {
    ctx.beginPath();
    ctx.arc(points[i].x, points[i].y, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
    ctx.strokeStyle = '#2980b9';
    ctx.lineWidth = 2.5;
    ctx.stroke();

    /* Data label */
    ctx.fillStyle = '#2c3e50';
    ctx.font = 'bold 11px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(dataPoints[i].toFixed(0) + '%', points[i].x, points[i].y - 12);
  }

  /* X-axis labels */
  ctx.fillStyle = '#7f8c8d';
  ctx.font = '10px Segoe UI, system-ui, sans-serif';
  ctx.textAlign = 'center';
  for (var i = 0; i < points.length; i++) {
    var label = labels[i] || '';
    /* Truncate long labels */
    if (label.length > 20) label = label.substring(0, 18) + '...';

    ctx.save();
    ctx.translate(points[i].x, padTop + chartH + 12);
    ctx.rotate(-0.4);
    ctx.textAlign = 'right';
    ctx.fillText(label, 0, 0);
    ctx.restore();
  }
}

/* ================================================================
   CLASS SUMMARY
   ================================================================ */
function renderClassSummary() {
  var selectedClass = document.getElementById('classSummarySelect').value;
  var body = document.getElementById('classSummaryBody');
  if (!selectedClass) {
    body.innerHTML = '';
    return;
  }

  var tests = appData.tests;
  var classStudents = {};
  var testAverages = [];

  for (var t = 0; t < tests.length; t++) {
    var headers = tests[t].headers || [];
    var rows = tests[t].rows || [];
    var nameIdx = getColIndex(headers, 'Student Name');
    var classIdx = getColIndex(headers, 'Class');
    var pctIdx = getColIndex(headers, 'Percentage');

    var classScores = [];
    for (var r = 0; r < rows.length; r++) {
      var cls = classIdx >= 0 ? String(rows[r][classIdx]).trim() : '';
      if (cls !== selectedClass) continue;

      var name = nameIdx >= 0 ? String(rows[r][nameIdx]).trim() : '';
      var pct = pctIdx >= 0 ? parsePercentage(rows[r][pctIdx]) : 0;

      classScores.push({ name: name, pct: pct });
      if (!classStudents[name]) classStudents[name] = [];
      classStudents[name].push({ testName: tests[t].name, pct: pct });
    }

    if (classScores.length > 0) {
      var sum = 0;
      for (var i = 0; i < classScores.length; i++) sum += classScores[i].pct;
      testAverages.push({
        testName: tests[t].name,
        avg: sum / classScores.length,
        count: classScores.length
      });
    }
  }

  if (testAverages.length === 0) {
    body.innerHTML = '<p style="color:#95a5a6;padding:16px 0;">No students found in this class.</p>';
    return;
  }

  var html = '';

  /* Average per test */
  html += '<h4 style="margin:16px 0 10px;color:var(--primary);font-size:0.95rem;">Average Score per Test</h4>';
  html += '<div class="bar-chart" style="margin-bottom:20px">';
  for (var i = 0; i < testAverages.length; i++) {
    var ta = testAverages[i];
    var color = ta.avg >= 70 ? 'var(--correct)' : ta.avg >= 40 ? 'var(--accent)' : 'var(--incorrect)';
    html += '<div class="bar-row">';
    html += '<div class="bar-label" title="' + escapeHtml(ta.testName) + '">' + escapeHtml(ta.testName) + '</div>';
    html += '<div class="bar-track"><div class="bar-fill" style="width:' + Math.max(ta.avg, 1) + '%;background:' + color + '">' + (ta.avg > 15 ? ta.avg.toFixed(1) + '%' : '') + '</div></div>';
    html += '<div class="bar-value">' + ta.avg.toFixed(1) + '%</div>';
    html += '</div>';
  }
  html += '</div>';

  /* Student standing */
  var overallClassAvg = 0;
  var studentOverall = {};
  var studentNames = Object.keys(classStudents);
  for (var i = 0; i < studentNames.length; i++) {
    var entries = classStudents[studentNames[i]];
    var sum = 0;
    for (var j = 0; j < entries.length; j++) sum += entries[j].pct;
    var avg = sum / entries.length;
    studentOverall[studentNames[i]] = avg;
    overallClassAvg += avg;
  }
  if (studentNames.length > 0) overallClassAvg /= studentNames.length;

  studentNames.sort(function(a, b) { return studentOverall[b] - studentOverall[a]; });

  html += '<h4 style="margin:16px 0 10px;color:var(--primary);font-size:0.95rem;">Student Standing <span style="font-weight:400;color:#7f8c8d;font-size:0.85rem;">(Class avg: ' + overallClassAvg.toFixed(1) + '%)</span></h4>';
  html += '<div class="table-wrap"><table>';
  html += '<thead><tr><th>Student</th><th>Avg %</th><th>Tests</th><th>Standing</th></tr></thead>';
  html += '<tbody>';
  for (var i = 0; i < studentNames.length; i++) {
    var nm = studentNames[i];
    var avg = studentOverall[nm];
    var numTests = classStudents[nm].length;
    var above = avg >= overallClassAvg;
    var standingHtml = above
      ? '<span style="color:var(--correct);font-weight:600;">\u25B2 Above Average</span>'
      : '<span style="color:var(--incorrect);font-weight:600;">\u25BC Below Average</span>';
    html += '<tr>';
    html += '<td>' + escapeHtml(nm) + '</td>';
    html += '<td><strong>' + avg.toFixed(1) + '%</strong></td>';
    html += '<td>' + numTests + '</td>';
    html += '<td>' + standingHtml + '</td>';
    html += '</tr>';
  }
  html += '</tbody></table></div>';

  body.innerHTML = html;
}

/* ================================================================
   INIT
   ================================================================ */
window.addEventListener('DOMContentLoaded', function() {
  var savedUrl = getSavedUrl();
  document.getElementById('sheetUrlInput').value = savedUrl;
  restoreLastLoaded();

  if (savedUrl) {
    toggleSettings();
    loadData();
  } else {
    toggleSettings();
  }
});

/* Handle canvas resize for the line chart */
window.addEventListener('resize', function() {
  var canvas = document.getElementById('studentLineChart');
  if (canvas && canvas._dataPoints) {
    drawLineChart(canvas, canvas._dataPoints, canvas._labels);
  }
});
</script>
</body>
</html>